#include <vector>
#include <cmath>
#include <cstring>
#include <iostream>
#include <stdio.h>
#include <stdlib.h>
#include <nlopt.hpp>
#include <iomanip>
#include <gsl/gsl_sf_lambert.h>


#include "LR.h"
//#include "Minuit2/FCNBase.h"

double getTotalNumEvents(CL_input input)
{
	double mS = input.mS;
	double mZprime = input.mZprime;

	FILE *ptr_file;
    	
	char buf[3000];

	char * pch;
	
	double totNum = -1e5;

	int n = 1;
	int m = 0;
	char s[100];
	char filename[500] = "../MC/HIST_\0";
	sprintf(s,"%.3lf_%.3lf.dat", mS, mZprime);
	strcat(filename,s);
//	printf("Total Filename: %s\n",filename);
	ptr_file =fopen(filename,"r");

    	if (!ptr_file)
       	{			
		printf("ERROR LOADING MC EVENTS 2\n");
		return 1;
	}
    	while (fgets(buf,3000, ptr_file)!=NULL)
	{
		if(m==1)
		{
			pch = strtok(buf,"\t");
			n=1;
 			while (pch != NULL)
			{
//				printf("%.7g, ", strtof(pch,NULL));
				if(n==3){	//printf("%.7g, ",strtof(pch,NULL));
						totNum = strtof(pch,NULL);	 
					 	fclose(ptr_file);
						return totNum;
					}
				else { 
					pch = strtok(NULL,"\t"); 
				}
				n++;	
			}
		}
		m++;
	}

fclose(ptr_file);
return totNum;
}

int EtoBin(double E)
{
	return floor(E/0.1);
}
double BintoCentralE(int bin)
{
	return 0.1*(((double)bin)+0.5);
}

int CostoBin(double C)
{
	return floor((1+C)/0.2);
}
double BintoCentralCos(int b)
{
	return (((double)b)+0.5)*0.2-1.0;
}

int QEtoBin(double QE)
{
	int ans=0;
	std::vector<double > QEbinLow = {0.2,0.3,0.375,0.475,0.55,0.675,0.8,0.95,1.1,1.3,1.5};
	std::vector<double > QEbinDel = {0.1,0.075,0.1,0.075,0.125,0.125,0.15,0.15,0.2,0.2,1.5};
	for(int i = 0;i<QEBINS;i++){
		if(QEbinLow[i]<= QE &&  QE <= (QEbinLow[i]+QEbinDel[i]))
		{
			ans = i;
		}
	
	}
	if(QE < QEbinLow[0] || QE > (QEbinLow[QEBINS-1]+QEbinDel[QEBINS-1]) )
		{
		ans=999;
		}
	return ans;
}

double BintoCentalQE(int b)
{
	std::vector<double > QEbinLow = {0.2,0.3,0.375,0.475,0.55,0.675,0.8,0.95,1.1,1.3,1.5};
	std::vector<double > QEbinDel = {0.1,0.075,0.1,0.075,0.125,0.125,0.15,0.15,0.2,0.2,1.5};
	return QEbinLow[b]+QEbinDel[b]/2.0;
}

int which_BINS(int which_var){
	int BINS =0;

	if (which_var == 0)
	{	
		BINS=EBINS;
	} else if (which_var ==1)
	{ 
		BINS=COSBINS;
	} else if (which_var ==2)
	{
		BINS=QEBINS;
	}

return BINS;
}

double QEfromEandCos(double Evis, double costh){
	double Mn = 0.9395666;
	double Mp = 0.938272;
	double Dms= Mn*Mn-Mp*Mp;
	double EB = 0.00786; //Binging energy of carbon per nuclear
	double Me = 0.000510998;

	double c1= -0.1472; double c2=0.2788; double c3=0.0898;double c4=-0.0196;
	double a1= 0.9942; double a2=0.0113; //MC corrections

	double EvisCor= a1*(Evis-Me)+a2+Me;
	double beta = sqrt(1-Me*Me/(EvisCor*EvisCor));
	double ans1 =  0.5*((2.0*Mn+EB)*EvisCor-(Dms+2*Mn*EB+EB*EB+Me*Me))/((Mn+EB)-EvisCor+sqrt(EvisCor*EvisCor-Me*Me)*costh);
	double Q2=2*ans1*EvisCor*(1-beta*costh)-Me*Me;
	
	//return  0.5*((2.0*Mn+EB)*Evis-(Dms+2*Mn*EB+EB*EB+Me*Me))/((Mn+EB)-Evis+sqrt(EvisCor*Evis-Me*Me)*costh);
	return ans1-(c1+c2*Q2+c3*Q2*Q2+c4*pow(Q2,3));
}


double decayProb(CL_input input, double chiU, double Es)
{
	double mS = input.mS;
	double mZprime = input.mZprime;

	double L = 1.0; // 1 metre.
	double g1 = 0.2;

	double alpha = mS*mS/(mZprime*mZprime-mS*mS);

	double prefac = (chiU*chiU*(1.0/(137.05*137.05))*alpha*alpha*mS/(4.0*pow(4.0*M_PI,3.0)*g1*g1));
	//double func = (3.0/(2.0*alpha*alpha*alpha))*((2+alpha-3*alpha*alpha)/(1+alpha))+(4*alpha*alpha-3)*log(1.0+alpha)/pow(alpha,4.0);
	double func;
	if(alpha < 0.01)
	{
	
		double func_perturb_0 = (1.0/(1.0+alpha))*(7.0/4.0 + 41.0/60.0*alpha); 

		double func_perturb_rest = -0.18333*pow(alpha,2.0)+0.22857*pow(alpha,3.0)-0.23274*pow(alpha,4.0)+0.22421*pow(alpha,5.0)-0.21190*pow(alpha,6.0)+0.19899*pow(alpha,7.0)-0.18662*pow(alpha,8.0)+0.17517*pow(alpha,9.0)-0.16475*pow(alpha,10.0)+0.15531*pow(alpha,11.0);
		func = func_perturb_0+func_perturb_rest;
	}
	else 
	{		
		func = (3.0/(2.0*pow(alpha,3.0)))*(2+alpha-3*pow(alpha,2.0))/(1.0+alpha) + (4.0*alpha*alpha-3.0)*(log(1+alpha)/log(exp(1.0)))/pow(alpha,4.0);
	}


//printf("### mS: %.5lf\tmZ: %.5lf\talpha: %.5lf\tprefac: %.5lf\tfunc: %.5lf\n",mS,mZprime,alpha,prefac,func); 

return 1.0-exp(-(0.51e16)*prefac*func*L*mS/Es);
} 

double histogrammer(CL_input in, double chiU, double cutEff, const double events[][NUM_EVENT_OBS], double eGram[], double cosGram[], double qeGram[])
{
	double finalScale = getTotalNumEvents(in);


	int i=0;
	for(i=0;i<COSBINS;i++)
	{
		cosGram[i]=0.0;
	}

	for(i=0;i<EBINS;i++)
	{
		eGram[i]=0.0;
	}
	
	for(i=0;i<QEBINS;i++)
	{
		qeGram[i]=0.0;
	}

	double total = 0.0;
	double probTotal = 0.0;
	double prob = 0.0;
	int qeWhichBin = 0;
	double QEprob=0.0;
	double QEtotal = 0.0;
	double QEprobTotal = 0.0;

	for(i=0;i<NUMEVENTS;i++)
	{
		if(events[i][0] > 1e-4)
		{			
			//These lines DO NOT CONSIDER containment effects.
//			eGram[EtoBin(events[i][0])] +=1.0;
//			cosGram[CostoBin(events[i][2])] +=1.0;
			
			//These lines account for containment effects.
			prob = decayProb(in,chiU,events[i][3]);
			QEprob=prob;
			eGram[EtoBin(events[i][0])] += prob;
			cosGram[CostoBin(cos((M_PI/180.0)*events[i][1]))] += prob;

			qeWhichBin = QEtoBin(QEfromEandCos(events[i][0],cos((M_PI/180.0)*events[i][1])));

			if(qeWhichBin == 999) //Error Bin 
			{
				QEprob=0;
				QEtotal+=0.0;
				QEprobTotal+=QEprob;
			} else {
				QEprob=prob;
				qeGram[qeWhichBin] += QEprob;	
				QEtotal+=1.0;
				QEprobTotal+=QEprob;
			}
			
			total+=1.0;
			probTotal+=prob;
			
//		        printf("event %d: prob = %.5g\tprobTot = %.5g\n",i,prob,probTotal);

		}
	}

	double cosTot = 0.0;

	for(i=0;i<COSBINS;i++)
	{
		cosGram[i]=chiU*chiU*cutEff*finalScale*cosGram[i]/total;
		cosTot+=cosGram[i];
	}

	for(i=0;i<EBINS;i++)
	{
		eGram[i]=chiU*chiU*cutEff*finalScale*eGram[i]/total;
	}

	for(i=0;i<QEBINS;i++)
	{
		qeGram[i]=chiU*chiU*cutEff*finalScale*qeGram[i]/total;
	}

//printf("chiU: %.5g\tTot: %.5g\tprobTot/total: %.5g\tcosTot: %.5g\n",chiU, total, probTotal/total, cosTot);

return probTotal/total;
}

double histogrammer_indiv(CL_input in, double chiU, double cutEff, const double events[][NUM_EVENT_OBS], double Gram[], int which_var)
{
	double finalScale = getTotalNumEvents(in);

	int BINS=which_BINS(which_var);
	
	int i=0;
	for(i=0;i<BINS;i++)
	{
		Gram[i]=0.0;
	}
	
	double total = 0.0;
	double probTotal = 0.0;
	double prob = 0.0;
	int qeWhichBin = 0;

	for(i=0;i<NUMEVENTS;i++)
	{
		if(events[i][0] > 1e-4)
		{			
			//These lines DO NOT CONSIDER containment effects.
//			eGram[EtoBin(events[i][0])] +=1.0;
//			cosGram[CostoBin(events[i][2])] +=1.0;
			
			//These lines account for containment effects.
			
			
			prob = decayProb(in,chiU,events[i][3]);
			if( which_var ==0 ){

				
				
				      	Gram[EtoBin(events[i][0])] += prob;
					total+=1.0;
					probTotal+=prob;
	
			} else if (which_var==1)
		       	{
					Gram[CostoBin(cos((M_PI/180.0)*events[i][1]))] += prob;
					total+=1.0;
					probTotal+=prob;
			}  else if (which_var==2) 
			{
				qeWhichBin = QEtoBin(QEfromEandCos(events[i][0],cos((M_PI/180.0)*events[i][1])));
	
				if(qeWhichBin == 999) //Error Bin 
				{
					prob=0;
					total+=0.0;
				} else {
					Gram[qeWhichBin] += prob;	
					total+=1.0;
					probTotal+=prob;
				}
			}
			
		
//		        printf("event %d: prob = %.5g\tprobTot = %.5g\n",i,prob,probTotal);

		}
	}

	

	for(i=0;i<BINS;i++)
	{
		Gram[i]=chiU*chiU*cutEff*finalScale*Gram[i]/total;
	}
//printf("chiU: %.5g\tTot: %.5g\tprobTot/total: %.5g\tcosTot: %.5g\n",chiU, total, probTotal/total, cosTot);

return probTotal/total;
}
double boundU( double ms){
        double peakB=1;
        double fit1 = -1.7969808082063344*pow(10,-8); 
        double fit2 = 0.6078622816783561;
        

        if(ms < 0.003){
                peakB = 0.3*exp(-3000*ms);
        } else if (ms>=0.003 && ms<=0.03){
                peakB = 5*pow(10,-5)*exp(-100*ms)+fit1;
        } else if (ms>0.03){
               peakB = pow(10,-5)*exp(-30*ms)*fit2;
        }              


return sqrt(peakB);
}
double boundUpeaky( double ms, double mz){ //Definitely on U not U^2
        std::vector<double  > peakBounds = {0.01238242210078086,0.0012535309071088556,0.00004547996544027682,0.00003486400316563211,0.000048498500851545515,0.000043481154180279925,0.00003814588076274375,0.000032810607345207566,0.00002747533392767138,0.000022140060510135193,0.00001848513484898103,0.000016648710422498732,0.000014812285996016437,0.000012975861569534138,0.000011139437143051847,9.30301271656955e-6,0.000011722952207256827,0.000022348900710157802,0.000014199121671679938,0.000015074668173337534,0.000020663287575263602,0.000025736549869991898,0.000020780763938661232,0.000012406536764883298,9.2148124995948e-6,0.000010398349461906154,0.000013692168512906922,0.000010611689039650524,0.000014181454464076391,0.00003452605035229107,0.00009980899398935939,0.00010519659404478175,0.0001287558277072979,0.002567828076615406,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0.06000974457459983,0.0005491388780786994,0.00008692580899813938,0.00007546678867820339,0.0000670313055282429,0.00006149850811247785,0.000056060882219892045,0.000051026402899493555,0.00004599192357909507,0.00004104215865575888,0.00003610485398698345,0.00003213214118430577,0.000028244726729530042,0.000025169261508564636,0.000022141273340815894,0.000020562787108851245,0.0000189843008768866,0.000017852308552278194,0.000016917644673245147,0.000015983782288916364,0.000015148034253223484,0.000014312286217530604,0.000013505417644784022,0.00001275916261975577,0.000012012907594727518,0.000011338142722287882,0.000010704064528463935,0.00001006998633463999,9.526190122643592e-6,8.986956234247341e-6,8.467789113472166e-6,8.003854169017238e-6,7.53991922456231e-6,7.160113098379005e-6,6.840955099379955e-6,6.5217971003809065e-6,6.3318009105642275e-6,6.156846509179875e-6,5.985745424164471e-6,5.829114967200497e-6,5.672484510236525e-6,5.521599525386795e-6,5.37591519009579e-6,5.230230854804784e-6,5.087619257316122e-6,4.9455951893717475e-6,4.805406514441987e-6,4.6752942018612466e-6,4.545181889280506e-6,4.417519134905032e-6,4.2926333217711365e-6,4.167747508637242e-6,4.049179574916104e-6,3.9323597050098456e-6,3.816522894308477e-6,3.709746907510374e-6,3.6029709207122713e-6,3.499494812756753e-6,3.4007190291538117e-6,3.30194324555087e-6,3.2070640684738203e-6,3.1136475954414644e-6,3.020568557785226e-6,2.9352498238875896e-6,2.849931089989953e-6,2.7672257597970884e-6,2.6892425193466815e-6,2.611259278896275e-6,2.537195845154522e-6,2.4650555080396757e-6,2.3929151709248293e-6,2.330525315023786e-6,2.268279280424445e-6,2.214568314856435e-6,2.180766612833341e-6,2.1469649108102475e-6,2.4198725176186026e-6,2.7216475579144377e-6,2.0966538412613143e-6,2.0253156984318495e-6,1.9961258269669026e-6,1.9673640166810762e-6,1.9399295294714553e-6,1.912495042261834e-6,1.8852879607601946e-6,1.8582606792909906e-6,1.8312333978217863e-6,1.8051073001928576e-6,1.7791122410725753e-6,1.7534105274634778e-6,1.7289787269396175e-6,1.7045469264157571e-6,1.6802972597673258e-6,1.6562280965818638e-6,1.632158933396402e-6,1.6088406528305205e-6,1.5856907359328586e-6,1.5627238101488947e-6,1.5409660542164883e-6,1.519208298284082e-6,1.4975945902102746e-6,1.4761597811967042e-6,1.4547249721831336e-6,1.4339128498842612e-6,1.4132966762533873e-6,1.3929102467418403e-6,1.3753476443561706e-6,1.357785041970501e-6,1.3399414361535207e-6,1.3216580086911777e-6,1.3033745812288345e-6,1.2870494525040906e-6,1.2715459864491707e-6,1.2560363895453765e-6,1.2402107856410494e-6,1.2243851817367222e-6,1.208606292505019e-6,1.1929207081162453e-6,1.1772351237274717e-6,1.1619023787167372e-6,1.1467611082781001e-6,1.1316198378394632e-6,1.1173391202070031e-6,1.103091628191469e-6,1.0891755749541034e-6,1.0761227856741227e-6,1.0630699963941423e-6,1.049245380636674e-6,1.0348888779993191e-6,1.0205323753619645e-6,1.0078534419944996e-6,9.953472956818846e-7,9.828612409601408e-7,9.704459174192359e-7,9.58030593878331e-7,9.458402983494787e-7,9.338449477363838e-7,9.218495971232891e-7,9.099445015299672e-7,8.980552816649877e-7,8.865691437366877e-7,8.771226750527884e-7,8.67676206368889e-7,8.604063361970309e-7,8.554981404876014e-7,8.505899447781719e-7,8.45965467421851e-7,8.414145063002377e-7,8.36870668157861e-7,8.323851723641769e-7,8.278996765704929e-7,8.229777591882111e-7,8.174615167119161e-7,8.119452742356211e-7,8.068986428948552e-7,8.020187287402743e-7,7.97170820728625e-7,7.928993966947452e-7,7.886279726608653e-7,7.844750742472907e-7,7.805264348198531e-7,7.765777953924155e-7,7.723140844312032e-7,7.679033245258074e-7,7.634925646204116e-7,7.583921238025582e-7,7.53289186433596e-7,7.49616095778962e-7,7.491108669201028e-7,7.486056380612436e-7,7.484164748860745e-7,7.484164748860745e-7,7.484164748860745e-7,7.484164748860745e-7,7.484164748860745e-7,7.484164748860745e-7,7.484164748860745e-7,7.484164748860745e-7,7.484164748860745e-7,7.484164748860745e-7,7.484164748860745e-7,7.484164748860745e-7,7.484164748860745e-7,7.484164748860745e-7,7.484164748860745e-7,7.484164748860745e-7,7.484164748860745e-7,7.484164748860745e-7,7.484164748860745e-7,7.484164748860745e-7,7.484164748860745e-7,7.486326590018433e-7,7.501510949021517e-7,7.5166953080246e-7,7.5507081708941e-7,7.607095383894657e-7,7.663482596895214e-7,7.718708673676847e-7,7.773590983725809e-7,7.828564088070003e-7,7.884500101962749e-7,7.940436115855495e-7,7.99790138024983e-7,8.05765322474927e-7,8.117405069248709e-7,8.178017044525785e-7,8.238971259124898e-7,8.29996222249347e-7,8.362143002158433e-7,8.424323781823396e-7,8.487939530180891e-7,8.554284966675317e-7,8.620630403169741e-7,8.705623709518909e-7,8.800259643610491e-7,8.894895577702071e-7,9.01033569021355e-7,9.126336532681836e-7,9.243508473482959e-7,9.363570657300174e-7,9.483632841117388e-7,9.60222145954891e-7,9.719839719334927e-7,9.837457979120944e-7,9.964954041190646e-7,1.0093337728480576e-6,1.0222764886696772e-6,1.0355643454942937e-6,1.04885220231891e-6,1.0619921752723847e-6,1.0750095513212539e-6,1.0880269273701229e-6,1.1017430642494136e-6,1.1155716865453261e-6,1.129621624355504e-6,1.1447081469858667e-6,1.159794669616229e-6};
     
	int which = floor(ms/0.001)-1;        
	return sqrt(peakBounds[which]);
}

double boundNOMADtau(double ms){ //Its on Ut not Ut^2
	std::vector<double > nomad = {1,1,1,1,1,1,1,1,1,1,1,1,1,1,0.944635,0.852174,0.770464,0.698715,0.636138,0.581943,0.53534,0.495736,0.46232,0.433937,0.409662,0.388527,0.36584,0.344877,0.325548,0.307763,0.291432,0.276466,0.262877,0.250471,0.239139,0.228776,0.219277,0.210539,0.202457,0.194627,0.187165,0.180197,0.173688,0.167602,0.161903,0.156428,0.151268,0.146406,0.141819,0.13749,0.133396,0.129519,0.125838,0.122264,0.118783,0.115461,0.112291,0.109265,0.106376,0.103618,0.100983,0.0984492,0.0960231,0.0937044,0.0914881,0.0893697,0.0873444,0.0854091,0.0835606,0.0817907,0.0800941,0.0784656,0.0768999,0.0753919,0.0739362,0.0725153,0.0710932,0.0697113,0.0683688,0.0670649,0.0657988,0.0645696,0.0633765,0.0622187,0.0610954,0.060004,0.0589454,0.0579188,0.0569237,0.0559594,0.055025,0.05412,0.0532436,0.052395,0.0515736,0.0507833,0.0500258,0.0492915,0.048579,0.0478868,0.0472132,0.0465567,0.0459159,0.045289,0.0446573,0.0440357,0.0434271,0.0428316,0.0422494,0.0416809,0.0411261,0.0405854,0.0400708,0.0395744,0.0390921,0.038623,0.0381663,0.0377213,0.0372873,0.0368634,0.036449,0.0360431,0.0356452,0.0352496,0.0348552,0.0344688,0.0340905,0.0337202,0.0333581,0.0330042,0.0325889,0.0320566,0.0315715,0.0311602,0.0308492,0.0306649,0.0306337,0.0310813,0.0318507,0.0327424,0.0337186,0.0347415,0.0357732,0.0367396,0.0374714,0.0381666,0.038829,0.0394625,0.0400756,0.0407185,0.0413488,0.041965,0.0425655,0.0431488,0.0437132,0.0442572,0.0447792,0.0452776,0.0457509,0.0461974,0.0465322,0.0468379,0.0471232,0.047391,0.0476448,0.0478876,0.0481226,0.0483531,0.0485824,0.0488134,0.0490412,0.0492765,0.0495255,0.0497922,0.0500806,0.0503948,0.0507388,0.0515816,0.0551717,0.0569659,0.0574001,0.0569104,0.0559328,0.0549033,0.054258,0.0544329,0.055864,0.0589873,0.0642388,0.0720547,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1};

	int which = floor(ms/0.001)-1;
	return nomad[which];
}

double boundEWGM2(double mz){	// On chi not chi^2
        std::vector<double  > pbound={0.005493,0.0054934494593645005,0.005516684727995264,0.005540698201766924,0.005565435241826981,0.005590841209322936,0.005616861465402291,0.005643441371212547,0.005670526287901203,0.005698061576615761,0.0057259925985037215,0.005754264714712586,0.005782823286389856,0.00581161367468303,0.005840581240739611,0.005869671345707098,0.005898829350732993,0.005928000616964798,0.005957130505550011,0.005985491139683609,0.006013387205738451,0.0060411750937474935,0.006068868938583959,0.00609648287512107,0.006124031038232046,0.006151527562790112,0.006178986583668488,0.006206422235740396,0.006233848653879057,0.006261491179358337,0.006289177943217135,0.0063168753759571756,0.006344583479882775,0.0063723022572982485,0.00640003171050791,0.006427771841816074,0.006455522653527056,0.00648328414794517,0.006511056327374731,0.006538839115712961,0.006566632362863981,0.00659443631660801,0.006622250994545555,0.00665007641427712,0.006677912593403211,0.006705759549524336,0.006733617300240998,0.006761485863153704,0.0067893652558629605,0.006817255495969271,0.006845156601073144,0.006873090343783916,0.006901041220430379,0.00692900128557677,0.006956969360057443,0.00698494426470675,0.007012924820359045,0.00704090984784868,0.0070688981680100075,0.0070968886016773815,0.007124879969685155,0.007152871092867679,0.007180860792059309,0.007208836258799467,0.007236783491833275,0.0072647270299595395,0.007292666990076306,0.007320603489081623,0.0073485366438735345,0.007376466571350089,0.007404393388409331,0.00743231721194931,0.007460238158868069,0.007488156346063655,0.007516071890434117,0.0075439849088775,0.007571895518291851,0.00759980437431941,0.0076277111416732995,0.007655615822107223,0.00768351851316308,0.007711419312382774,0.007739318317308207,0.00776721562548128,0.007795111334443897,0.007823005541737958,0.007850898344905365,0.007878789841488022,0.007906680129027831,0.007934569305066693,0.00796245746714651,0.007990344880228057,0.008018231947723354,0.008046118279561386,0.008074003956590763,0.008101889059660092,0.008129773669617984,0.008157657867313046,0.008185541733593888,0.008213425349309115,0.008241308795307338,0.008269192152437165,0.008297075501547204,0.008324958923486066,0.008352842499102356,0.008380726309244683,0.008408610434761658,0.008436459027079339,0.0084642669466509,0.008492077187795696,0.008519891546298793,0.00854771181794525,0.008575539798520129,0.008603377283808495,0.008631226069595406,0.008659087951665928,0.008686964725805121,0.008714858187798047,0.00874277013342977,0.008770702358485347,0.008798656658749847,0.008826634830008328,0.008854638668045851,0.008882669968647481,0.008910811375108373,0.008939127400931213,0.008967472504747553,0.00899584423186644,0.009024240127596917,0.009052657737248036,0.00908109460612884,0.009109548279548378,0.009138016302815697,0.009166496221239844,0.009194985580129867,0.009223481924794812,0.009251982800543727,0.00928048575268566,0.009308988326529656,0.009337488067384762,0.009365982520560028,0.0093944692313645,0.009422945745107223,0.009451256109739731,0.009479522699290562,0.009507775646590744,0.00953601545129041,0.009564242613039689,0.009592457631488712,0.009620661006287612,0.009648853237086518,0.009677034823535562,0.009705206265284873,0.009733368061984585,0.009761520713284828,0.009789664718835732,0.009817800578287428,0.009845928791290048,0.009874049857493723,0.009902164276548582,0.00993027254810476,0.009958375171812384,0.009986472647321587,0.010014533208969507,0.010042580767634098,0.01007062537409303,0.01009866809562115,0.010126709999493295,0.010154752152984309,0.010182795623369033,0.01021084147792231,0.01023889078391898,0.010266944608633886,0.010295004019341874,0.01032307008331778,0.010351143867836447,0.01037922644017272,0.010407318867601439,0.010435422217397445,0.010463537556835581,0.01049166595319069,0.010519808473737614,0.010547966185751191,0.010576140156506268,0.01060434660214558,0.01063279206542773,0.010661255704542624,0.010689735821361313,0.010718230717754853,0.010746738695594294,0.010775258056750692,0.010803787103095097,0.010832324136498563,0.010860867458832144,0.01088941537196689,0.01091796617777386,0.010946518178124101,0.010975069674888668,0.011003618969938615,0.011032164365144993,0.011060704162378856,0.011089236663511259,0.01111776017041325,0.011146272984955886,0.01117477340901022,0.011203259744447304,0.01123173029313819,0.011260183356953933,0.01128841653075556,0.01131646314635964,0.011344490477493861,0.011372500493655464,0.01140049516434169,0.011428476459049779,0.011456446347276971,0.01148440679852051,0.011512359782277635,0.011540307268045587,0.011568251225321608,0.011596193623602938,0.01162413643238682,0.011652081621170492,0.011680031159451197,0.011707987016726177,0.011735951162492672,0.011763925566247922,0.011791912197489169,0.011819913025713655,0.011847930020418618,0.011875965151101302,0.011904020387258948,0.011932097698388796,0.011960199053988086,0.011988359344167272,0.012016911451297116,0.012045492226142766,0.012074100253711568,0.012102734119010871,0.012131392407048016,0.012160073702830353,0.012188776591365224,0.01221749965765998,0.012246241486721965,0.012275000663558524,0.012303775773177003,0.01233256540058475,0.012361368130789106,0.012390182548797424,0.012419007239617044,0.012447840788255315,0.012476681779719582,0.012505528799017191,0.012534380431155488,0.01256323526114182,0.012592091873983531,0.01262094885468797,0.012649804788262478,0.012678658259714407,0.012707507854051099,0.0127363521562799,0.012765189751408158,0.01279388265872702,0.012822433921349475,0.012850975692533148,0.0128795085121186,0.012908032919946393,0.01293654945585709,0.012965058659691253,0.01299356107128944,0.013022057230492216,0.013050547677140142,0.013079032951073778,0.013107513592133687,0.01313599014016043,0.01316446313499457,0.013192933116476667,0.013221400624447283,0.01324986619874698,0.01327833037921632,0.013306793705695862,0.01333525671802617,0.013363719956047806,0.013392183959601331,0.013420649268527306,0.013449116422666291,0.013477585961858852,0.013506058425945548,0.013534534354766939,0.013563014288163588,0.013591498765976059,0.01361998832804491,0.013648583114863016,0.013677237755967827,0.01370589831569745,0.013734564382630179,0.013763235545344305,0.013791911392418121,0.013820591512429922,0.013849275493957997,0.013877962925580644,0.013906653395876151,0.013935346493422814,0.013964041806798924,0.013992738924582776,0.01402143743535266,0.014050136927686871,0.014078836990163702,0.014107537211361444,0.014136237179858391,0.014164936484232837,0.014193634713063072,0.014222331454927392,0.01425102629840409,0.014279718832071454,0.014308408644507782,0.014337095324291366,0.014365778460000495,0.014394457640213468,0.014423132453508573,0.014451802488464106,0.014480467333658356,0.014509126577669621,0.01453777980907619,0.014566364923381299,0.014594810445482194,0.014623249157850097,0.014651681677813796,0.014680108622702082,0.014708530609843744,0.014736948256567574,0.01476536218020236,0.014793772998076894,0.014822181327519965,0.014850587785860361,0.014878992990426878,0.0149073975585483,0.014935802107553423,0.014964207254771033,0.01499261361752992,0.015021021813158876,0.015049432458986692,0.015077846172342155,0.015106263570554057,0.015134685270951189,0.01516311189086234,0.015191544047616301,0.01521998235854186,0.01524842744096781,0.015276879912222938,0.015305340389636038,0.015333809490535897,0.015362287832251307,0.015390776032111054,0.015419274707443933,0.015447784475578735,0.015476305953844248,0.015504839759569261,0.015533386510082566,0.0155620228897073,0.015590845338250323,0.01561968220295787,0.015648532982368683,0.015677397175021503,0.015706274279455076,0.01573516379420814,0.01576406521781944,0.01579297804882772,0.015821901785771714,0.015850835927190176,0.01587977997162184,0.01590873341760545,0.015937695763679753,0.015966666508383486,0.015995645150255394,0.016024631187834218,0.016053624119658702,0.016082623444267585,0.016111628660199613,0.016140639265993528,0.016169654760188067,0.01619867464132198,0.016227698407934008,0.01625672555856289,0.01628575559174737,0.016314788006026187,0.01634382229993809,0.01637285797202182,0.016401894520816113,0.016430931444859718,0.016459968242691372,0.016489004412849825,0.016518039453873812,0.016547072864302077,0.016576104142673367,0.01660513278752642,0.016634158297399976,0.016663118517971615,0.016691980287690828,0.016720837627472115,0.0167496906359917,0.016778539411925815,0.016807384053950682,0.016836224660742534,0.016865061330977597,0.016893894163332094,0.016922723256482256,0.01695154870910431,0.016980370619874487,0.017009189087469005,0.017038004210564103,0.017066816087835997,0.017095624817960925,0.01712443049961511,0.017153233231474774,0.017182033112216152,0.01721083024051547,0.017239624715048953,0.017268416634492828,0.017297206097523325,0.01732599320281667,0.017354778049049096,0.01738356073489682,0.017412341359036076,0.01744112002014309,0.01746989681689409,0.017498671847965303,0.017527445212032953,0.017556217007773274,0.01758498733386249,0.017613756288976826,0.017642523971792515,0.017671290480985778,0.01770005591523285,0.017728820373209952,0.017757583953593312,0.017786346755059163,0.017815108876283726,0.017843864848733872,0.017872609698883393,0.017901354176008497,0.01793009843197376,0.017958842618643764,0.017987586887883086,0.018016331391556305,0.018045076281528002,0.018073821709662756,0.01810256782782514,0.018131314787879743,0.01816006274169114,0.01818881184112391,0.018217562238042627,0.018246314084311877,0.018275067531796238,0.018303822732360288,0.018332579837868606,0.018361339000185772,0.018390100371176363,0.018418864102704963,0.018447630346636143,0.018476399254834488,0.018505170979164577,0.01853394567149099,0.018562723483678302,0.018591504567591097,0.01862028907509395,0.01864907715805144,0.01867786896832815,0.018706664657788655,0.01873546437829754,0.018764268281719378,0.01879307651991875,0.018821889244760234,0.018850706608108413,0.018879528761827864,0.018908355857783166,0.018937188047838897,0.018966025483859637,0.018994868317709968,0.019023716701254464,0.019052570786357706,0.01908143072488427,0.019110296668698745,0.019139273777445023,0.019168270091540335,0.01919727264753014,0.019226281267314915,0.01925529577279514,0.0192843159858713,0.019313341728443872,0.01934237282241334,0.01937140908968018,0.019400450352144872,0.0194294964317079,0.01945854715026974,0.019487602329730874,0.019516661791991786,0.01954572535895295,0.01957479285251485,0.019603864094577966,0.019632938907042777,0.019662017111809767,0.01969109853077941,0.019720182985852187,0.019749270298928586,0.01977836029190908,0.01980745278669415,0.01983654760518428,0.019865644569279948,0.01989474350088163,0.019923844221889815,0.019952946554204976,0.019982050319727596,0.020011155340358154,0.020040261437997132,0.02006936843454501,0.02009847615190227,0.020127584411969386,0.020156693036646845,0.020185801847835125,0.020214910667434704,0.020244019317346065,0.02027312761946969,0.020302235395706053,0.02033134246795564,0.020360448658118927,0.0203895537880964,0.02041865767978853,0.020447760155095807,0.020476861035918708,0.02050596014415771,0.020534950307478518,0.020563903613429337,0.020592854756779605,0.020621803897669096,0.02065075119623758,0.020679696812624833,0.020708640906970627,0.020737583639414733,0.020766525170096927,0.02079546565915698,0.02082440526673467,0.02085334415296976,0.020882282478002036,0.020911220401971256,0.020940158085017205,0.020969095687279653,0.02099803336889837,0.02102697129001313,0.021055909610763708,0.021084848491289877,0.02111378809173141,0.021142728572228077,0.02117167009291965,0.02120061281394591,0.021229556895446623,0.021258502497561567,0.02128744978043051,0.021316398904193224,0.021345350028989487,0.02137430331495907,0.02140325892224175,0.021432217010977292,0.021461177741305473,0.021490141273366067,0.021519107767298845,0.021548077383243585,0.021577050281340052,0.021606026621728027,0.021635006564547275,0.021663990269937577,0.0216929778980387,0.02172196960899042,0.02175096556293251,0.02177996592000474,0.021808970840346886,0.021837980484098723,0.02186699501140002,0.021896014582390547,0.021925039357210085,0.021954069495998402,0.021983105158895275,0.022012146506040473,0.022041310104444666,0.022070547511374324,0.022099791010559436,0.02212904038716838,0.02215829542636954,0.022187555913331287,0.022216821633222007,0.022246092371210075,0.022275367912463873,0.02230464804215178,0.02233393254544217,0.02236322120750343,0.022392513813503937,0.022421810148612064,0.022451109997996196,0.02248041314682471,0.022509719380265986,0.0225390284834884,0.022568340241660337,0.022597654439950172,0.022626970863526285,0.022656289297557055,0.02268560952721086,0.022714931337656084,0.022744254514061098,0.022773578841594286,0.02280290410542403,0.022832230090718702,0.022861556582646686,0.02289088336637636,0.022920210227076104,0.022949536949914296,0.02297886332005931,0.02300818912267954,0.023037514142943347,0.02306683816601912,0.023096160977075238,0.023125482361280078,0.02315480210380202,0.023184119989809442,0.023213435804470727,0.023242749332954248,0.023272060360428386,0.023301368672061524,0.023330674053022037,0.023359976288478308,0.02338927516359871,0.023418570463551627,0.023447861973505436,0.023477149478628518,0.02350643276408925,0.023535711615056014,0.023564985816697186,0.023594255154181145,0.02362351941267627,0.023652778377350945,0.023681756029692934,0.02370955787407699,0.023737352857418258,0.02376514327633354,0.02379293142743965,0.02382071960735339,0.02384851011269157,0.023876305240070998,0.023904107286108485,0.023931918547420834,0.023959741320624853,0.023987577902337354,0.024015430589175137,0.02404330167775502,0.0240711934646938,0.024099108246608287,0.024127048320115294,0.024155015981831625,0.02418301352837409,0.024211043256359494,0.024239107462404645,0.02426720844312635,0.02429534849514142,0.02432352991506666,0.024351754999518877,0.024380026045114883,0.02440834534847148,0.024436715206205478,0.024465137914933682,0.024493615771272906,0.024522151071839953,0.024550746113251632,0.02457940319212475,0.024608124605076116,0.024636912648722534,0.024665769619680818,0.02469469781456777,0.0247236995300002,0.024752777062594912,0.02478193270896872,0.02481116876573843,0.024840487529520845,0.024869891296932775,0.024899382364591032,0.024928963029112416,0.024958635587113743,0.024988402335211813,0.02501826557002344,0.025048227588165425,0.02507829068625458,0.025108457160907715,0.02513872930874163,0.025169109426373144,0.02519959981041905,0.02523020275749617,0.0252609205642213,0.025291755527211256,0.025322709943082843,0.025353786108452868,0.025384986319938137,0.02541631287415546,0.02544815830014034,0.025485008701626545,0.025521991726343573,0.025559101614469854,0.025596332606183828,0.025633678941663927,0.02567113486108859,0.025708694604636255,0.025746352412485355,0.025784102524814324,0.0258219391818016,0.025859856623625617,0.02589784909046481,0.025935910822497618,0.025974036059902478,0.026012219042857818,0.02605045401154208,0.0260887352061337,0.02612705686681111,0.02616541323375275,0.02620379854713705,0.026242207047142453,0.026280632973947386,0.026319070567730293,0.026357514068669607,0.02639595771694376,0.026434395752731193,0.026472822416210337,0.026511231947559635,0.026549618586957514,0.026587976574582416,0.02662630015061277,0.02666458355522702,0.026702821028603597,0.026741006810920936,0.026779135142357476,0.026817200263091652,0.026855196413301894,0.026893117833166648,0.02693095876286434,0.02696871344257341,0.027006376112472297,0.02704394101273943,0.02708140238355325,0.027118754465092192,0.027155991497534688,0.027193107721059175,0.027230097375844094,0.027266954702067872,0.027303673939908953,0.027340249329545766,0.027376675111156754,0.027412945524920344,0.02744905481101498,0.027484997209619094,0.02752076696091112,0.027556358305069494,0.027591765482272653,0.027626982732699035,0.027662004296527074,0.027696824413935204,0.027731437325101863,0.027765837270205485,0.027800018489424507,0.027833975222937363,0.027860159371236416,0.027885785995508325,0.027911158504275474,0.027936281074744645,0.02796115788412263,0.027985793109616214,0.028010190928432183,0.02803435551777733,0.028058291054858436,0.028082001716882295,0.028105491681055694,0.028128765124585415,0.028151826224678253,0.02817467915854099,0.028197328103380416,0.02821977723640332,0.028242030734816487,0.028264092775826706,0.028285967536640765,0.02830765919446545,0.02832917192650755,0.028350509909973856,0.028371677322071152,0.02839267834000623,0.028413517140985868,0.02843419790221686,0.028454724800905995,0.02847510201426006,0.028495333719485844,0.02851542409379013,0.028535377314379707,0.028555197558461365,0.028574889003241892,0.028594455825928074,0.0286139022037267,0.028633232313844556,0.02865245033348843,0.028671560439865112,0.028690566810181384,0.02870947362164404,0.02872828505145987,0.02874700527683565,0.02876563847497818,0.02878418882309424,0.028802660498390625,0.02882105767807411,0.028839384539351497,0.028857645259429566,0.028875844015515108,0.028893984984814904,0.02891207234453575,0.02893011027188443,0.028948102944067734,0.028966054538292443,0.028983969231765355,0.029001851201693248,0.029019704625282916,0.029037533679741143,0.02905534254227472,0.029073135390090432,0.029090916400395066,0.029108689750395416,0.02912645961729826,0.029144230178310394,0.029162005610638603,0.029179790091489674,0.029196968546587265,0.02919659286863819,0.029196183088367092,0.029195752963229935,0.02919530258897112,0.02919483206133507,0.02919434147606619,0.029193830928908895,0.0291933005156076,0.029192750331906717,0.029192180473550655,0.02919159103628383,0.029190982115850656,0.02919035380799554,0.029189706208462902,0.029189039412997147,0.029188353517342697,0.029187648617243954,0.029186924808445338,0.02918618218669126,0.029185420847726132,0.029184640887294368,0.02918384240114038,0.029183025485008576,0.029182190234643378,0.029181336745789193,0.02918046511419043,0.02917957543559151,0.029178667805736844,0.029177742320370837,0.02917679907523791,0.029175838166082473,0.029174859688648937,0.029173863738681718,0.029172850411925227,0.029171819804123873,0.029170772011022077,0.029169707128364242,0.02916862525189479,0.029167526477358124,0.029166410900498665,0.029165278617060822,0.02916412972278901,0.029162964313427638,0.02916178248472112,0.02916058433241387,0.0291593699522503,0.029158139439974824,0.029156892891331852,0.029155630402065796,0.029154352067921073,0.029153057984642093,0.02915174824797327,0.02915042295365901,0.029149082197443738,0.029147726075071857,0.029146354682287785,0.02914496811483593,0.029143566468460707,0.029142149838906527,0.029140718321917808,0.029139272013238956,0.02913781100861439,0.029136335403788516,0.029134845294505753,0.02913334077651051,0.0291318219455472,0.029130288897360232,0.029128741727694026,0.029127180532292993,0.029125605406901543};
	int which = floor(mz/0.001)-100;        
	return pbound[which];
}


double boundPS191(double ms){  //ON U not U^2
        std::vector<double  > pbound ={0.0494184,0.040744,0.0335923,0.0276959,0.0228345,0.0188264,0.0155218,0.0127973,0.010551,0.00869901,0.00717209,0.00635742,0.00576645,0.00523041,0.00473906,0.0042786,0.00386288,0.00348755,0.00326191,0.00309512,0.00293686,0.00278669,0.0026442,0.00250899,0.0023807,0.00225972,0.00215783,0.00206054,0.00196763,0.00199937,0.00253861,0.00322329,0.00374949,0.00363455,0.00352314,0.00341514,0.00331045,0.00320898,0.00311061,0.00301526,0.00292283,0.00283323,0.00274638,0.00262611,0.00250682,0.00239295,0.00228425,0.00218049,0.00208144,0.00199885,0.0019445,0.00189163,0.00184019,0.00179015,0.00174148,0.00169412,0.00164806,0.00160324,0.00156351,0.00152572,0.00148885,0.00145286,0.00141775,0.00138348,0.00135004,0.00131741,0.00128557,0.0012545,0.00122418,0.00119459,0.00116571,0.00113754,0.00111005,0.00108322,0.00105703,0.00103149,0.00100655,0.000982227,0.000958486,0.000937871,0.000919194,0.00090089,0.00088295,0.000865367,0.000848134,0.000831245,0.000814692,0.000798468,0.000782568,0.000766984,0.000751711,0.000736742,0.00072207,0.000707691,0.000693599,0.000679786,0.000666249,0.000652982,0.000639979,0.000627234,0.000617035,0.000607032,0.000597191,0.00058751,0.000577986,0.000568616,0.000559399,0.00055033,0.000541409,0.000532632,0.000523998,0.000515503,0.000507146,0.000498925,0.000490837,0.00048288,0.000475052,0.000467351,0.000459774,0.000452321,0.000444988,0.000437775,0.000430678,0.000423696,0.000416828,0.000410071,0.000403423,0.000396883,0.000390449,0.000384464,0.000379623,0.000374842,0.000370121,0.00036546,0.000360858,0.000356313,0.000351826,0.000347396,0.000343021,0.000338701,0.000334435,0.000330224,0.000326065,0.000321959,0.000317904,0.000313901,0.000309948,0.000306044,0.00030219,0.000298385,0.000294627,0.000290917,0.000287253,0.000283636,0.000280064,0.000276537,0.000273054,0.000269615,0.00026622,0.000262867,0.000259557,0.000256288,0.000253061,0.000249874,0.000246727,0.00024362,0.000240552,0.000237523,0.000234531,0.000231578,0.000228661,0.000225782,0.000223499,0.000221374,0.000219268,0.000217183,0.000215118,0.000213072,0.000211046,0.000209039,0.000207051,0.000205083,0.000203132,0.000201201,0.000199287,0.000197392,0.000195515,0.000193656,0.000191814,0.00018999,0.000188184,0.000186394,0.000184622,0.000182866,0.000181127,0.000179405,0.000177699,0.000176009,0.000174335,0.000172677,0.000171035,0.000169409,0.000167798,0.000166202,0.000164621,0.000163056,0.000161505,0.00015997,0.000158448,0.000156944,0.000155548,0.000154164,0.000152792,0.000151432,0.000150085,0.000148749,0.000147426,0.000146114,0.000144814,0.000143818,0.000142985,0.000142157,0.000141334,0.000140516,0.000139702,0.000138893,0.000138089,0.000137289,0.000136494,0.000135704,0.000134918,0.000134136,0.00013336,0.000132587,0.00013182,0.000131056,0.000130297,0.000129543,0.000128792,0.000128047,0.000127305,0.000126568,0.000125835,0.000125106,0.000124382,0.000123661,0.000122945,0.000122233,0.000121526,0.000120822,0.000120122,0.000119427,0.000118735,0.000118047,0.000117364,0.000116684,0.000116008,0.000115337,0.000114669,0.000114005,0.000113344,0.000112688,0.000112035,0.000111387,0.000110742,0.0001101,0.000109463,0.000108829,0.000108199,0.000107572,0.000106949,0.00010633,0.000105714,0.000105102,0.000104493,0.000103888,0.000103286,0.000102688,0.000102094,0.000101502,0.000100915,0.00010033,0.0000997493,0.0000991716,0.0000985973,0.0000980263,0.0000974587,0.0000968943,0.0000963332,0.0000957753,0.0000952207,0.0000946693,0.000094121,0.000093576,0.0000930341,0.0000924953,0.0000919876,0.0000914844,0.000090984,0.0000904862,0.0000899913,0.000089499,0.0000890094,0.0000885225,0.0000880382,0.0000875566,0.0000870777,0.0000866013,0.0000861276,0.0000856564,0.0000851879,0.0000847218,0.0000842584,0.0000837975,0.0000833391,0.0000828832,0.0000824298,0.0000819789,0.0000815304,0.0000810844,0.0000806408,0.0000801997,0.000079761,0.0000793247,0.0000788907,0.0000784592,0.00007803,0.0000776031,0.0000771786,0.0000767564,0.0000763365,0.0000762056,0.0000762515,0.0000762975,0.0000763436,0.0000763896,0.0000764357,0.0000764818,0.000076528,0.0000765741,0.0000766203,0.0000766664,0.0000767122,0.0000767581,0.0000768039,0.0000768498,0.0000768958,0.0000769417,0.0000769877,0.0000770338};
	int which = floor(ms/0.001)-1;        
	return pbound[which];
}

double boundChi(double mz){
        double babarB=1;
        
        if(mz<0.25){
                babarB=-0.001*0.9987312619554833*pow(mz - 0.1,0.284) + 0.001;
        } else if(mz>=0.25 && mz<0.52){
                babarB=0.000392*exp(mz*mz);
        } else if(mz>=0.52){
                babarB=0.0012*pow(mz,1.3) + pow(8.671375207584429,-7);
        }

return babarB;
}

double boundUtau(double ms){

	double result= 5.684603155097915*exp(-224.36106435213696*ms) +0.1538995418716346*exp(-62.349043302533644*ms)+ 0.0005635403465693567*exp(-6.096293940788484*ms);

	if(ms<0.009){ result = 1; }
	return sqrt(result);
}


double ps191general(double ms, double mzp){
	return pow(boundPS191(ms)*(mzp/91.1876),2);
}

double M2G (double m) {
return (100*1e5*1e9*m)/1.973;
}

double Gvee(double U, double ms){
	double PI=3.14159;
	double GF=0.00001166;
	return U*U*pow(ms,5)*GF*GF/(96*PI*PI*PI);
}

double GammaNeeded2DecayBefore(double mn, double en, double L, double L0){

	double U=1;

	double BR=0.126469;

	double Gtot= Gvee(U,mn);
	double pn = sqrt(en*en-mn*mn);
	double B = exp(-Gtot*mn*M2G(L)/pn)*(1-exp(-mn*M2G(L0)*Gtot/pn))*BR;
	double A = L0/L;
	
	return -pn/(mn*M2G(L))*gsl_sf_lambert_Wm1(-B/A);
}

double decaybeforePS191(double mn, double mz){
	return	sqrt(GammaNeeded2DecayBefore(mn, 0.5, 128.0, 12.0)*pow(mz/91.1876,4)/Gvee(1,mn)  );
}


double whatsmaxUXorder1(double ms, double mz){

	double result = 1;
	//Currenlty only order 1 one
	double peaksearch  = sqrt(boundUpeaky(ms, mz)); //sqrt as U=sqrt(UpUd) and Ud=1
	double ewprecision = boundEWGM2(mz);		//unavoidable
	double decaybefore = decaybeforePS191(ms,mz);

	if(decaybefore < ewprecision)
	{ 
		result = ewprecision*peaksearch;
	} else {	
		result = sqrt(ps191general(ms,mz));
	}
return result;
}

double whatsmaxUXtau(double ms, double mz){

	double result = 1;
	//Currenlty only order 1 one
	double peaksearch  = sqrt(boundUpeaky(ms,mz)); //sqrt as U=sqrt(UpUd) and Ud=1
	double ewprecision = boundEWGM2(mz);		//unavoidable
	double decaybefore = decaybeforePS191(ms,mz);

	//if(decaybefore < ewprecision)
	//{ 
	//	result = ewprecision*peaksearch;
	//} else {
	
		result = sqrt(ps191general(ms,mz));
	//}
		

return result;
}




double nuisFuncE(const std::vector<double> &x, std::vector<double> &grad, void *my_data){
        
        nuisStruct *d = reinterpret_cast<nuisStruct*>(my_data);
        std::vector<double > eGram = d->egram;
        double sigma_zeta = d->Sigma_Zeta;


        double zeta_b = x[0];
                                 //{204, 280, 214, 99, 83, 59, 51, 33, 37, 23, 19, 21, 12, 16, 4, 9, 4, 7, 3}
        std::vector<double > eO = {204.0, 280.0,214.0, 99.0, 83.0, 59.0, 51.0, 33.0, 37.0, 23.0, 19.0, 21.0, 12.0, 16.0, 4.0, 9.0, 4.0, 7.0, 3.0};
        std::vector<double > eB = {151.5, 218.8, 155.6, 108.7, 72.5, 57.6, 45, 38.5, 31.4,22.2, 20.4, 17.2, 14.1, 10.2, 9.1, 8.2, 5.6, 5.7, 2.9};

        double temp_sig=0,temp_bg=0,lambda=0,N=0, E_N_events=0,E_N_sig_events=0,E_N_bg_events= 0,E_sum = 0;
        double sigma_s = 1.0;
        int bin = 0;
        for(bin=0;bin<EBINS;bin++)
                        {
                                temp_sig = sigma_s*eGram[bin];
                                temp_bg = (1.0+zeta_b)*eB[bin];
                                lambda = temp_sig + temp_bg;
                                N = eO[bin]; //MB has seen O[] events.
                                
                                E_N_events += lambda;
                                E_N_sig_events += temp_sig;
                                E_N_bg_events += temp_bg;
                        //      E_sum+= (lambda-N)*(lambda-N)/lambda;
                                E_sum+= 2.0*(lambda-N) + 2.0*N*log(N/lambda);
                //              std::cout<<E_sum<<std::endl;
                        }
        E_sum+= pow((zeta_b/sigma_zeta),2.0);
        //std::cout<<std::setprecision(12)<<zeta_b<<"  "<<E_sum<<std::endl;

return E_sum;
}


double nuisFuncA(const std::vector<double> &x, std::vector<double> &grad, void *my_data){
        
        nuisStruct *d = reinterpret_cast<nuisStruct*>(my_data);
        std::vector<double > cosGram = d->egram;
        std::vector<double > postGram(COSBINS,0);

        double sigma_zeta = d->Sigma_Zeta;
        double RunSigma = 1;
        //if(sigma_zeta == 0){RunSigma =0;};


        double zeta_b = x[0];
        
        std::vector<double > aO = {22,34,43,41,60,87,90,139,237,429};
        std::vector<double > aB = {19.9,23.1,28.8,32.1,46.4,63.1,86.1,121,196.8,390};

        double temp_sig=0,temp_bg=0,lambda=0,N=0, A_N_events=0,A_N_sig_events=0,A_N_bg_events= 0,A_sum = 0;
        double sigma_s = 1.0;
        int bin = 0;
        for(bin=0;bin<COSBINS;bin++)
                        {
                                temp_sig = sigma_s*cosGram[bin];
                                temp_bg = (1.0+zeta_b)*aB[bin];
                                lambda = temp_sig + temp_bg;
                                N = aO[bin]; //MB has seen O[] events.
                                
                                A_N_events += lambda;
                                A_N_sig_events += temp_sig;
                                A_N_bg_events += temp_bg;
                        //      E_sum+= (lambda-N)*(lambda-N)/lambda;
                                A_sum+= 2.0*(lambda-N) + 2.0*N*log(N/lambda);
                                postGram[bin]=lambda;
                //              std::cout<<E_sum<<std::endl;
                        }
        A_sum+= RunSigma*pow((zeta_b/sigma_zeta),2.0);
        //std::cout<<std::setprecision(12)<<zeta_b<<"  "<<E_sum<<std::endl;
        //d->egram = postGram;

return A_sum;
}

double nuisFuncQE(const std::vector<double> &x, std::vector<double> &grad, void *my_data){
        
        nuisStruct *d = reinterpret_cast<nuisStruct*>(my_data);
        std::vector<double > qeGram = d->egram;
        double sigma_zeta = d->Sigma_Zeta;


        double zeta_b = x[0];
                                 //{204, 280, 214, 99, 83, 59, 51, 33, 37, 23, 19, 21, 12, 16, 4, 9, 4, 7, 3}
        std::vector<double > qeO = {232,156,156,79,81,70,63,65,62,34,70};
        std::vector<double > qeB = {181.1,108.4,120.4,64.2,90.3,67.7,70.4,57.5,52.3,39,70.2};

        double temp_sig=0,temp_bg=0,lambda=0,N=0, QE_N_events=0,QE_N_sig_events=0,QE_N_bg_events= 0,QE_sum = 0;
        double sigma_s = 1.0;
        int bin = 0;
        for(bin=0;bin<QEBINS;bin++)
                        {
                                temp_sig = sigma_s*qeGram[bin];
                                temp_bg = (1.0+zeta_b)*qeB[bin];
                                lambda = temp_sig + temp_bg;
                                N = qeO[bin]; //MB has seen O[] events.
                                
                                QE_N_events += lambda;
                                QE_N_sig_events += temp_sig;
                                QE_N_bg_events += temp_bg;
                        //      E_sum+= (lambda-N)*(lambda-N)/lambda;
                                QE_sum+= 2.0*(lambda-N) + 2.0*N*log(N/lambda);
                        }
        QE_sum+= pow((zeta_b/sigma_zeta),2.0);
        //std::cout<<std::setprecision(12)<<zeta_b<<"  "<<E_sum<<std::endl;

return QE_sum;
}

double boundChiU(double ms, double mz)
{
return boundChi(mz)*boundU(ms);
}



double maxChiUmUt(double ms, double mz)
{
// Will eventually get the case where they all decay, 	
// returns a bound on chi*U

return pow( pow(boundChi(mz),2)*boundU(ms)*boundUtau(ms),0.25)*(mz/91.0);

}

double nuisMarginalize(std::vector<double > * bf_zeta_b, double * chi, std::vector<double > * eVGram, int whi, double SIGMAZETA){
        
        nuisStruct ddata = {(*eVGram),SIGMAZETA};

        nlopt::opt full(nlopt::LN_COBYLA,1);
        
        //full.set_maxeval(200000);
        full.set_xtol_abs(1e-5);
        full.set_lower_bounds(-1);
        full.set_upper_bounds(1);
        std::vector<double > xtem = {0.01};
        double ctem;
        if(whi==0){ 
                full.set_min_objective(nuisFuncE, &ddata);
        } else if(whi==1){
                full.set_min_objective(nuisFuncA,&ddata);
        } else if(whi==2){
		full.set_min_objective(nuisFuncQE,&ddata);
	} else {
		std::cout<<"ERROR in LR.c ~ nuisMarginalise: spectrum selector which is > 2"<<std::endl;
	}


        
        //std::cout<<"Starting GLOBAL_FULL"<<std::endl;
        nlopt::result result = full.optimize(xtem, ctem);
        //std::cout<<"Minimized GLOBAL_FULL"<<std::endl;
        //std::cout<<"GLOBAl_FULL: found minimum at "<<xtem[0]<<" and thats "<<ctem<<std::endl;

        (*bf_zeta_b)=xtem;
        (*chi)=ctem;
        (*eVGram) = ddata.egram;

return 0;
}

